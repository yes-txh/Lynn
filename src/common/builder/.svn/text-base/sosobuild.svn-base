#!/bin/bash

# @brief tencent soso build script
# @author phongchen<phongchen@tencent.com>
# @date
# @version 1.0
# please place this file into your $PATH

SOSOBUILD_VERSION=1.0
SOSOBUILD_AUTHORS="phongchen <phongchen@tencent.com>"
SOSOBUILD_COPYRIGHT="Copyright (C) 2010 Tencent.com, Inc."
SOSOBUILD_COLOR=36;

function error_exit()
{
    if [ -t 2 ]; then
        echo -e "ERROR: \e[1;31m$@\e[m" >&2
    else
        echo -e "ERROR: $@" >&2
    fi
    exit 1
}

# find the 'common' dir
# search /common/builder/Generic.mak
function find_common ()
{
    local dir
    dir=`pwd`;
    while [ "$dir" != "/" ]; do
        if [ -f "$dir/common/builder/Generic.mak" ]; then
            echo "$dir/common"
            return 0
        fi;
        dir=`dirname "$dir"`
    done
    return 1
}

function real_path()
{
    if result=`( cd "$1" 2>/dev/null && pwd )`; then
        echo "$result"
        return 0
    fi
    return 1
}

function show_version()
{
    echo -e "`cat << EOF
\e[1;35mSosobuild $SOSOBUILD_VERSION.
$SOSOBUILD_COPYRIGHT
\e[m
EOF`"
    make -v
}

function show_help()
{
    echo -e "`cat << EOF
\e[1;35mSosobuild options:
  -v show version information.
  -h show help information.
Report bugs to $SOSOBUILD_AUTHORS
\e[m
GNU Make options:
EOF`"
make -h
}

# handle -v and -h flags
if [ $# -eq 1 ]; then
    if [ "$1" == "-v" ]; then
        show_version
        exit
    elif [ "$1" == "-h" ]; then
        show_help
        exit
    fi
fi

if ! COMMON=`find_common`; then
    error_exit "Can't find common directory, are you in correct source tree?"
fi

if ! ROOT=`real_path $COMMON/../..`; then
    error_exit "Can't find project root directory, are you in correct source tree?"
fi

if ! THIRD_PARTY=`real_path $COMMON/../thirdparty`; then
    error_exit "Can't find project root directory, are you in correct source tree?"
fi

SRC=`real_path $COMMON/..`

SOSBUILD=1

export COMMON
export ROOT
export THIRD_PARTY
export SOSO_BUILD=1

echo -e "\e[1;${SOSOBUILD_COLOR}m`cat << EOF
Sosobuild $SOSOBUILD_VERSION. Report bugs to $SOSOBUILD_AUTHORS
ROOT   is $ROOT
COMMON is $COMMON\n
EOF`\e[m"

make -I $COMMON/builder project.predefined_includes="$SRC $ROOT/src/thirdparty" $@
